<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UoA Grade Dashboard</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background: #000; color: white; font-family: -apple-system, sans-serif; }
        .glass { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 20px; }
        .search-input { background: rgba(255, 255, 255, 0.1); border: none; outline: none; transition: 0.3s; }
        .search-input:focus { background: rgba(255, 255, 255, 0.15); box-shadow: 0 0 0 2px #3b82f6; }
        
        .term-btn { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); cursor: pointer; position: relative; }
        .term-btn:active { transform: scale(0.95); }
        .term-btn.active-all { background: rgba(255, 255, 255, 0.15); color: white; border-color: rgba(255,255,255,0.3); }
        .term-btn.active-ss { background: rgba(245, 158, 11, 0.25); color: #f59e0b; border-color: rgba(245, 158, 11, 0.5); box-shadow: 0 0 15px rgba(245, 158, 11, 0.1); }
        .term-btn.active-s1 { background: rgba(59, 130, 246, 0.25); color: #3b82f6; border-color: rgba(59, 130, 246, 0.5); box-shadow: 0 0 15px rgba(59, 130, 246, 0.1); }
        .term-btn.active-s2 { background: rgba(139, 92, 246, 0.25); color: #a78bfa; border-color: rgba(139, 92, 246, 0.5); box-shadow: 0 0 15px rgba(139, 92, 246, 0.1); }
    </style>
</head>

<body class="p-4 md:p-8">
    <div id="app" class="max-w-6xl mx-auto">
        <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-10 gap-4">
            <div class="flex items-center gap-4">
                <img src="https://icons.auckland.ac.nz/assets/logos/uoa/vertical/uoa_logo.svg" alt="University of Auckland" class="h-12 md:h-16">
                <div>
                    <h1 class="text-3xl font-bold tracking-tight">UoA Grade <span class="text-blue-500">Insights</span></h1>
                    <p class="text-gray-500 text-sm">Official Data • Visualized for Students</p>
                </div>
            </div>
            <div class="relative w-full md:w-80">
                <input v-model="searchQuery" @input="handleSearch" placeholder="Search course (e.g. COMPSCI 101)"
                    class="search-input w-full py-3 px-6 rounded-full text-white">
                <div v-if="searchResults.length" class="absolute mt-2 w-full glass z-50 max-h-64 overflow-y-auto shadow-2xl">
                    <div v-for="res in searchResults" :key="res.id" @click="selectCourse(res.id)"
                        class="px-6 py-3 hover:bg-blue-500/20 cursor-pointer border-b border-white/5 last:border-0 transition-colors">
                        {{ res.id }}
                    </div>
                </div>
            </div>
        </header>

        <div v-if="currentCourse" class="space-y-6">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                <h2 class="text-4xl font-bold">{{ currentCourse }}</h2>
                
                <div class="flex items-center gap-3">
                    <div class="flex bg-white/5 p-1 rounded-xl border border-white/10 backdrop-blur-md">
                        <button v-for="opt in filterOptions" :key="opt.value" 
                            @click="toggleTerm(opt.value)"
                            :class="[
                                'px-5 py-2 rounded-lg text-xs font-bold uppercase tracking-wider term-btn border border-transparent',
                                selectedTerms.includes(opt.value) ? opt.activeClass : 'text-gray-500 hover:text-gray-300'
                            ]">
                            {{ opt.label }}
                        </button>
                    </div>
                    <button @click="exportReportImage"
                        :disabled="isExporting"
                        class="px-4 py-2 rounded-lg text-xs font-bold uppercase tracking-wider border border-white/20 bg-white/5 hover:bg-white/10 disabled:opacity-50 disabled:cursor-not-allowed">
                        {{ isExporting ? 'Exporting...' : 'Export PNG' }}
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="glass p-6 border-l-4 border-green-500">
                    <p class="text-xs text-gray-400 uppercase tracking-widest mb-1">Pass Rate</p>
                    <p class="text-3xl font-bold text-green-400">{{ selectedRecord?.pass_rate }}%</p>
                </div>
                <div class="glass p-6 border-l-4 border-blue-500">
                    <p class="text-xs text-gray-400 uppercase tracking-widest mb-1">A Range</p>
                    <p class="text-3xl font-bold text-blue-400">{{ selectedRecord?.a_rate }}%</p>
                </div>
                <div class="glass p-6 border-l-4 border-orange-500">
                    <p class="text-xs text-gray-400 uppercase tracking-widest mb-1">Risk (Fail/DNC)</p>
                    <p class="text-3xl font-bold text-orange-400">{{ selectedRecord?.risk_rate }}%</p>
                </div>
                <div class="glass p-6 border-l-4 border-gray-500">
                    <p class="text-xs text-gray-400 uppercase tracking-widest mb-1">Headcount</p>
                    <p class="text-3xl font-bold">{{ selectedRecord?.headcount }}</p>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="md:col-span-2 glass p-6">
                    <h3 class="text-sm font-semibold text-gray-400 mb-6 flex justify-between">
                        <span>Historical Trend</span>
                        <div class="flex items-center gap-2">
                            <button @click="toggleAnomaly"
                                :disabled="isAnomalyLocked"
                                :class="[
                                    'px-2 py-1 rounded-md text-[10px] uppercase tracking-wider border transition-colors disabled:opacity-60 disabled:cursor-not-allowed',
                                    anomalyEnabled
                                        ? 'text-emerald-300 border-emerald-500/50 bg-emerald-500/10'
                                        : 'text-gray-400 border-white/20 bg-white/5'
                                ]">
                                Anomaly {{ anomalyEnabled ? 'On' : 'Off' }}
                            </button>
                            <span class="text-blue-500">{{ selectedTerms.length === 3 ? 'All Terms' : selectedTerms.map(t => t === 'Summer' ? 'SS' : (t === 'Semester 1' ? 'S1' : 'S2')).join(', ') }}</span>
                        </div>
                    </h3>
                    <div class="h-[250px] relative">
                        <canvas id="trendChart"></canvas>
                    </div>
                    <div class="mt-4" v-if="anomalySummaries.length">
                        <div class="flex flex-col md:flex-row md:items-center md:gap-3 mb-2">
                            <p class="text-xs uppercase tracking-wider text-gray-400">
                                Anomalies (change >= {{ anomalyThreshold }}%)
                            </p>
                            <p class="text-[11px] text-amber-300 bg-amber-500/10 border border-amber-500/40 px-2 py-1 rounded-md">
                                Important: SS vs regular semester differences may not represent true course difficulty changes. Recommend excluding Summer School first.
                            </p>
                        </div>
                        <div class="space-y-1">
                            <p v-for="item in anomalySummaries" :key="item.key" class="text-xs text-gray-300">
                                {{ item.term }}: {{ item.changeLabel }} vs previous ({{ item.current }}% from {{ item.previous }}%)
                            </p>
                        </div>
                    </div>
                </div>
                <div class="glass p-6">
                    <h3 class="text-sm font-semibold mb-6 text-gray-400 text-center">
                        Grade Bands ({{ selectedRecord?.term }} {{ selectedRecord?.year }})
                    </h3>
                    <div class="h-[250px] relative">
                        <canvas id="bandChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div v-else class="h-96 flex flex-col items-center justify-center text-center">
            <div class="w-16 h-16 bg-white/5 rounded-2xl flex items-center justify-center mb-6 rotate-12 border border-white/10">
                <i class="text-blue-500 text-2xl font-black not-italic">UoA</i>
            </div>
            <h2 class="text-2xl font-semibold mb-2">Ready to explore?</h2>
            <p class="text-gray-500 max-w-sm">Search for any course code to see historical performance and grade distributions.</p>
        </div>
    </div>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    searchQuery: '',
                    index: [],
                    allData: {},
                    searchResults: [],
                    currentCourse: null,
                    selectedRecordIndex: 0,
                    selectedTermFilter: 'ALL',
                    selectedTerms: ['Summer', 'Semester 1', 'Semester 2'], // 默认全选
                    trendChart: null,
                    bandChart: null,
                    filterOptions: [
                        { label: 'SS', value: 'Summer', activeClass: 'active-ss' },
                        { label: 'S1', value: 'Semester 1', activeClass: 'active-s1' },
                        { label: 'S2', value: 'Semester 2', activeClass: 'active-s2' }
                    ],
                    anomalyEnabled: false,
                    anomalyThreshold: 8,
                    isAnomalyLocked: false,
                    isExporting: false,
                    isClickLocked: false,
                    lastClickTime: 0,
                    isMobile: /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)
                }
            },
            computed: {
                filteredRecords() {
                    if (!this.currentCourse || !this.allData[this.currentCourse]) return [];
                    const records = this.allData[this.currentCourse];
                    // 如果没有选中任何学期，返回空数组
                    if (this.selectedTerms.length === 0) return [];
                    // 根据选中的学期过滤
                    return records.filter(r => this.selectedTerms.includes(r.term));
                },
                selectedRecord() {
                    const records = this.filteredRecords;
                    if (!records.length) return null;
                    const validIndex = Math.min(Math.max(0, this.selectedRecordIndex), records.length - 1);
                    return records[validIndex];
                },
                anomalySummaries() {
                    if (!this.anomalyEnabled) return [];
                    const records = this.filteredRecords;
                    if (!records.length) return [];
                    const anomalies = [];
                    for (let i = 1; i < records.length; i++) {
                        const prev = Number(records[i - 1].pass_rate || 0);
                        const current = Number(records[i].pass_rate || 0);
                        const diff = current - prev;
                        if (Math.abs(diff) >= this.anomalyThreshold) {
                            const shortTerm = records[i].term === 'Summer'
                                ? 'SS'
                                : (records[i].term === 'Semester 1' ? 'S1' : 'S2');
                            anomalies.push({
                                key: `${records[i].year}-${records[i].term}-${i}`,
                                term: `${records[i].year} ${shortTerm}`,
                                changeLabel: `${diff > 0 ? '+' : ''}${diff.toFixed(1)}%`,
                                current: current.toFixed(1),
                                previous: prev.toFixed(1)
                            });
                        }
                    }
                    return anomalies;
                }
            },
            watch: {
                anomalyEnabled() {
                    if (!this.currentCourse) return;
                    this.renderCharts();
                }
            },
            async mounted() {
                try {
                    const [idxRes, dataRes] = await Promise.all([
                        fetch('search-index.json').then(r => r.json()),
                        fetch('course-data.json').then(r => r.json())
                    ]);
                    this.index = idxRes;
                    this.allData = dataRes;
                } catch (e) { 
                    console.error("Data loading failed", e);
                }
            },
            beforeUnmount() {
                this.destroyCharts();
            },
            methods: {
                destroyCharts() {
                    try {
                        if (this.trendChart) {
                            this.trendChart.destroy();
                            this.trendChart = null;
                        }
                        if (this.bandChart) {
                            this.bandChart.destroy();
                            this.bandChart = null;
                        }
                    } catch (e) {
                        console.error('Error destroying charts:', e);
                    }
                },
                toggleTerm(termValue) {
                    // 共享锁：任何操作都会禁止所有其他操作
                    if (this.isClickLocked) {
                        console.log('Please wait, operation in progress...');
                        return;
                    }
                    
                    this.isClickLocked = true;
                    
                    const index = this.selectedTerms.indexOf(termValue);
                    if (index > -1) {
                        // 如果已选中，则取消选择
                        this.selectedTerms.splice(index, 1);
                    } else {
                        // 如果未选中，则添加
                        this.selectedTerms.push(termValue);
                    }
                    
                    // 重置选中的记录索引为最新的一条
                    this.selectedRecordIndex = Math.max(0, this.filteredRecords.length - 1);
                    this.renderCharts();
                    
                    setTimeout(() => {
                        this.isClickLocked = false;
                    }, this.isMobile ? 1200 : 1000);
                },
                toggleAnomaly() {
                    if (this.isAnomalyLocked) return;
                    this.isAnomalyLocked = true;
                    this.anomalyEnabled = !this.anomalyEnabled;
                    setTimeout(() => {
                        this.isAnomalyLocked = false;
                    }, this.isMobile ? 900 : 700);
                },
                normalizeCourseText(value) {
                    return String(value || '')
                        .toUpperCase()
                        .replace(/[^A-Z0-9]/g, '');
                },
                expandAlias(normalizedQuery) {
                    const aliasRules = [
                        { from: /^CS(\d+)$/, to: 'COMPSCI$1' },
                        { from: /^COMSCI(\d+)$/, to: 'COMPSCI$1' },
                        { from: /^COMPSCIENCE(\d+)$/, to: 'COMPSCI$1' }
                    ];
                    for (const rule of aliasRules) {
                        if (rule.from.test(normalizedQuery)) {
                            return normalizedQuery.replace(rule.from, rule.to);
                        }
                    }
                    return normalizedQuery;
                },
                handleSearch() {
                    const rawQuery = this.searchQuery.trim();
                    if (!rawQuery) return this.searchResults = [];

                    const lowerQuery = rawQuery.toLowerCase();
                    const normalizedQuery = this.normalizeCourseText(rawQuery);
                    const expandedQuery = this.expandAlias(normalizedQuery);

                    const scored = this.index.map((item) => {
                        const id = item.id || '';
                        const lowerId = id.toLowerCase();
                        const normalizedId = this.normalizeCourseText(id);
                        let score = 0;

                        if (lowerId === lowerQuery) score += 120;
                        if (lowerId.includes(lowerQuery)) score += 90;
                        if (normalizedQuery && normalizedId.includes(normalizedQuery)) score += 80;
                        if (expandedQuery && expandedQuery !== normalizedQuery && normalizedId.includes(expandedQuery)) score += 70;
                        if (normalizedQuery && normalizedId.startsWith(normalizedQuery)) score += 20;
                        if (expandedQuery && normalizedId.startsWith(expandedQuery)) score += 15;

                        return { item, score };
                    });

                    this.searchResults = scored
                        .filter((entry) => entry.score > 0)
                        .sort((a, b) => b.score - a.score || a.item.id.localeCompare(b.item.id))
                        .slice(0, 8)
                        .map((entry) => entry.item);
                },
                selectCourse(id) {
                    // 共享锁：任何操作都会禁止所有其他操作
                    if (this.isClickLocked) {
                        console.log('Please wait, operation in progress...');
                        return;
                    }
                    
                    this.isClickLocked = true;
                    this.currentCourse = id;
                    this.searchResults = [];
                    this.searchQuery = '';
                    this.selectedTerms = ['Summer', 'Semester 1', 'Semester 2']; // 重置为全选

                    const termOrder = { 'Summer': 0, 'Semester 1': 1, 'Semester 2': 2 };
                    this.allData[id].sort((a, b) => {
                        if (a.year !== b.year) return a.year - b.year;
                        return (termOrder[a.term] ?? 9) - (termOrder[b.term] ?? 9);
                    });

                    this.selectedRecordIndex = this.allData[id].length - 1;
                    
                    this.$nextTick(() => {
                        this.renderCharts();
                        // 搜索后渲染两个图表：移动端4秒，桌面端1.5秒
                        setTimeout(() => {
                            this.isClickLocked = false;
                        }, this.isMobile ? 1800 : 1500);
                    });
                },
                getTermColor(term) {
                    const colors = { 'Summer': '#F59E0B', 'Semester 1': '#3B82F6', 'Semester 2': '#8B5CF6' };
                    return colors[term] || '#888';
                },
                renderCharts() {
                    // 销毁旧图表
                    this.destroyCharts();
                    
                    // 等待DOM更新后创建新图表
                    this.$nextTick(() => {
                        this.initTrendChart();
                        this.updateBandChart();
                    });
                },
                exportReportImage() {
                    if (!this.currentCourse || !this.selectedRecord) return;
                    const trendCanvas = document.getElementById('trendChart');
                    const bandCanvas = document.getElementById('bandChart');
                    if (!trendCanvas || !bandCanvas) return;

                    this.isExporting = true;
                    const reportCanvas = document.createElement('canvas');
                    reportCanvas.width = 2200;
                    reportCanvas.height = 1220;
                    const ctx = reportCanvas.getContext('2d');

                    const drawRoundedRect = (x, y, w, h, r, fillStyle, strokeStyle) => {
                        ctx.beginPath();
                        ctx.moveTo(x + r, y);
                        ctx.lineTo(x + w - r, y);
                        ctx.quadraticCurveTo(x + w, y, x + w, y + r);
                        ctx.lineTo(x + w, y + h - r);
                        ctx.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
                        ctx.lineTo(x + r, y + h);
                        ctx.quadraticCurveTo(x, y + h, x, y + h - r);
                        ctx.lineTo(x, y + r);
                        ctx.quadraticCurveTo(x, y, x + r, y);
                        ctx.closePath();
                        ctx.fillStyle = fillStyle;
                        ctx.fill();
                        if (strokeStyle) {
                            ctx.strokeStyle = strokeStyle;
                            ctx.lineWidth = 2;
                            ctx.stroke();
                        }
                    };

                    const termShortMap = { 'Summer': 'SS', 'Semester 1': 'S1', 'Semester 2': 'S2' };
                    const termSummary = this.selectedTerms.length === 3
                        ? 'All Terms'
                        : this.selectedTerms.map(t => termShortMap[t] || t).join(', ');
                    const record = this.selectedRecord;
                    const trendRecords = this.filteredRecords || [];
                    const headcount = Number(record.headcount || 0);
                    const bandPairs = [
                        { label: 'A Range', value: Number(record.bands?.A || 0) },
                        { label: 'B Range', value: Number(record.bands?.B || 0) },
                        { label: 'C Range', value: Number(record.bands?.C || 0) },
                        { label: 'Fail', value: Number(record.bands?.Fail || 0) },
                        { label: 'W', value: Number(record.bands?.W || 0) }
                    ];
                    const trendEntries = trendRecords.map((r) => {
                        const shortTerm = r.term === 'Summer' ? 'SS' : (r.term === 'Semester 1' ? 'S1' : 'S2');
                        return {
                            term: `${r.year}${shortTerm}`,
                            rate: `${Number(r.pass_rate || 0).toFixed(1)}%`
                        };
                    });

                    ctx.fillStyle = '#000000';
                    ctx.fillRect(0, 0, reportCanvas.width, reportCanvas.height);

                    ctx.fillStyle = '#ffffff';
                    ctx.font = 'bold 58px -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif';
                    ctx.fillText(this.currentCourse, 70, 90);
                    ctx.fillStyle = '#9ca3af';
                    ctx.font = '28px -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif';
                    ctx.fillText(`UoA Grade Insights Report`, 70, 130);
                    ctx.fillText(`View: ${termSummary} | Generated: ${new Date().toLocaleString()}`, 70, 168);

                    const kpis = [
                        { label: 'PASS RATE', value: `${record.pass_rate}%`, color: '#4ade80' },
                        { label: 'A RANGE', value: `${record.a_rate}%`, color: '#60a5fa' },
                        { label: 'RISK (FAIL/DNC)', value: `${record.risk_rate}%`, color: '#fb923c' },
                        { label: 'HEADCOUNT', value: `${record.headcount}`, color: '#d1d5db' }
                    ];

                    const cardY = 210;
                    const cardW = 500;
                    const gap = 24;
                    kpis.forEach((kpi, idx) => {
                        const x = 70 + idx * (cardW + gap);
                        drawRoundedRect(x, cardY, cardW, 150, 20, 'rgba(255,255,255,0.04)', 'rgba(255,255,255,0.16)');
                        ctx.fillStyle = '#9ca3af';
                        ctx.font = '22px -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif';
                        ctx.fillText(kpi.label, x + 28, cardY + 52);
                        ctx.fillStyle = kpi.color;
                        ctx.font = 'bold 60px -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif';
                        ctx.fillText(kpi.value, x + 28, cardY + 120);
                    });

                    const trendPanel = { x: 70, y: 390, w: 1420, h: 780 };
                    const bandPanel = { x: 1520, y: 390, w: 610, h: 780 };
                    drawRoundedRect(trendPanel.x, trendPanel.y, trendPanel.w, trendPanel.h, 24, 'rgba(255,255,255,0.03)', 'rgba(255,255,255,0.14)');
                    drawRoundedRect(bandPanel.x, bandPanel.y, bandPanel.w, bandPanel.h, 24, 'rgba(255,255,255,0.03)', 'rgba(255,255,255,0.14)');

                    ctx.fillStyle = '#9ca3af';
                    ctx.font = 'bold 34px -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif';
                    ctx.fillText('Historical Trend', trendPanel.x + 40, trendPanel.y + 55);
                    ctx.fillText(`Grade Bands (${record.term} ${record.year})`, bandPanel.x + 30, bandPanel.y + 55);

                    ctx.drawImage(trendCanvas, trendPanel.x + 30, trendPanel.y + 78, trendPanel.w - 60, 420);
                    ctx.drawImage(bandCanvas, bandPanel.x + 24, bandPanel.y + 78, bandPanel.w - 48, 420);

                    ctx.fillStyle = '#d1d5db';
                    ctx.font = 'bold 22px -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif';
                    ctx.fillText('Pass Rate Timeline', trendPanel.x + 32, trendPanel.y + 540);
                    ctx.fillText('Grade Bands Detail', bandPanel.x + 28, bandPanel.y + 540);

                    const timelineLeft = trendPanel.x + 32;
                    const timelineRight = trendPanel.x + trendPanel.w - 32;
                    let cursorX = timelineLeft;
                    let cursorY = trendPanel.y + 574;
                    const rowGap = 30;
                    trendEntries.forEach((entry) => {
                        const termText = `${entry.term}: `;
                        const rateText = entry.rate;
                        ctx.font = '17px -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif';
                        const termW = ctx.measureText(termText).width;
                        ctx.font = 'bold 18px -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif';
                        const rateW = ctx.measureText(rateText).width;
                        const dividerW = ctx.measureText('   |   ').width;
                        const totalW = termW + rateW + dividerW;
                        if (cursorX + totalW > timelineRight) {
                            cursorX = timelineLeft;
                            cursorY += rowGap;
                        }
                        ctx.fillStyle = '#9ca3af';
                        ctx.font = '17px -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif';
                        ctx.fillText(termText, cursorX, cursorY);
                        cursorX += termW;
                        ctx.fillStyle = '#ffffff';
                        ctx.font = 'bold 18px -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif';
                        ctx.fillText(rateText, cursorX, cursorY);
                        cursorX += rateW;
                        ctx.fillStyle = '#4b5563';
                        ctx.font = '16px -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif';
                        ctx.fillText('   |   ', cursorX, cursorY);
                        cursorX += dividerW;
                    });

                    ctx.fillStyle = '#9ca3af';
                    ctx.font = '18px -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif';
                    const rightStartX = bandPanel.x + 28;
                    const rightStartY = bandPanel.y + 575;
                    bandPairs.forEach((band, idx) => {
                        const pct = headcount > 0 ? (band.value / headcount) * 100 : 0;
                        const line = `${band.label}: ${band.value} (${pct.toFixed(1)}%)`;
                        ctx.fillText(line, rightStartX, rightStartY + idx * 40);
                    });

                    const termSafe = String(record.term || 'term').replace(/\s+/g, '-');
                    const filename = `${this.currentCourse}-${record.year}-${termSafe}-report.png`;
                    reportCanvas.toBlob((blob) => {
                        if (!blob) {
                            this.isExporting = false;
                            return;
                        }
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = filename;
                        a.click();
                        URL.revokeObjectURL(url);
                        this.isExporting = false;
                    }, 'image/png');
                },
                initTrendChart() {
                    const canvas = document.getElementById('trendChart');
                    if (!canvas) return;

                    const records = this.filteredRecords;
                    if (!records.length) return;

                    const ctx = canvas.getContext('2d');
                    const self = this;
                    const anomalyByIndex = {};
                    if (this.anomalyEnabled) {
                        for (let i = 1; i < records.length; i++) {
                            const prev = Number(records[i - 1].pass_rate || 0);
                            const current = Number(records[i].pass_rate || 0);
                            const diff = current - prev;
                            if (Math.abs(diff) >= this.anomalyThreshold) {
                                anomalyByIndex[i] = diff;
                            }
                        }
                    }
                    
                    this.trendChart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: records.map(r => `${r.year} ${r.term === 'Summer' ? 'SS' : (r.term === 'Semester 1' ? 'S1' : 'S2')}`),
                            datasets: [{
                                data: records.map(r => r.pass_rate),
                                backgroundColor: records.map(r => this.getTermColor(r.term)),
                                borderRadius: 6,
                                borderColor: records.map((_, idx) => {
                                    if (!(idx in anomalyByIndex)) return 'transparent';
                                    return anomalyByIndex[idx] > 0 ? '#22c55e' : '#ef4444';
                                }),
                                borderWidth: records.map((_, idx) => (idx in anomalyByIndex ? 2 : 0)),
                                hoverBorderWidth: records.map((_, idx) => (idx in anomalyByIndex ? 3 : 2)),
                                hoverBorderColor: records.map((_, idx) => {
                                    if (!(idx in anomalyByIndex)) return '#fff';
                                    return anomalyByIndex[idx] > 0 ? '#22c55e' : '#ef4444';
                                })
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            onClick: function(e, elements) {
                                if (elements.length > 0) {
                                    // 共享锁：任何操作都会禁止所有其他操作
                                    if (self.isClickLocked) {
                                        console.log('Please wait, operation in progress...');
                                        return;
                                    }
                                    
                                    self.isClickLocked = true;
                                    const clickedIndex = elements[0].index;
                                    self.selectedRecordIndex = clickedIndex;
                                    self.updateBandChart();
                                    
                                    setTimeout(() => {
                                        self.isClickLocked = false;
                                    }, self.isMobile ? 1200 : 1000);
                                }
                            },
                            scales: {
                                y: { min: 0, max: 100, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#666' } },
                                x: { grid: { display: false }, ticks: { color: '#888', font: { size: 10 } } }
                            },
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    callbacks: {
                                        afterLabel: (context) => {
                                            const idx = context.dataIndex;
                                            if (!(idx in anomalyByIndex)) return '';
                                            const diff = anomalyByIndex[idx];
                                            return `Change vs prev: ${diff > 0 ? '+' : ''}${diff.toFixed(1)}%`;
                                        }
                                    }
                                }
                            }
                        }
                    });
                },
                updateBandChart() {
                    const canvas = document.getElementById('bandChart');
                    if (!canvas || !this.selectedRecord) return;

                    // 销毁旧的band chart
                    if (this.bandChart) {
                        try {
                            this.bandChart.destroy();
                        } catch (e) {
                            console.error('Error destroying band chart:', e);
                        }
                        this.bandChart = null;
                    }

                    const bands = this.selectedRecord.bands;
                    const headcount = Number(this.selectedRecord.headcount || 0);
                    const ctx = canvas.getContext('2d');

                    // 创建新的band chart
                    this.bandChart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: ['A Range', 'B Range', 'C Range', 'Fail', 'W'],
                            datasets: [{
                                data: [bands.A, bands.B, bands.C, bands.Fail, bands.W],
                                backgroundColor: ['#3b82f6', '#8b5cf6', '#06b6d4', '#f97316', '#4b5563'],
                                borderRadius: 8
                            }]
                        },
                        options: {
                            indexAxis: 'y',
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    callbacks: {
                                        label: (context) => {
                                            const label = context.label || '';
                                            const value = Number(context.raw || 0);
                                            const percent = headcount > 0 ? (value / headcount) * 100 : 0;
                                            return `${label}: ${value} (${percent.toFixed(1)}%)`;
                                        }
                                    }
                                }
                            },
                            scales: {
                                x: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#666' } },
                                y: { grid: { display: false }, ticks: { color: '#fff' } }
                            }
                        }
                    });
                }
            }
        }).mount('#app');
    </script>
</body>
</html>
